/*! angular-sails-bind - v1.0.6 - 2015-10-30
* https://github.com/diegopamio/angular-sails-bind
* Copyright (c) 2015 Diego Pamio; Licensed MIT */
function findElementById(a,b){return angular.isArray(a)&&a.length?(b=parseInt(b,10),a.find(function(a){return a.id===b})):null}function diff(a,b){return a.filter(function(a){return b.indexOf(a)<0})}var app=angular.module("ngSailsBind",[]);app.factory("$sailsBind",["$q","$rootScope","$timeout","$log",function(a,b,c,d){"use strict";var e=function(e,h,i,j){function k(a){var b=h[e+"s"],f={created:function(){return h[e+"s"].push(a.data),!0},updated:function(){var c=findElementById(b,a.id);return c?(angular.extend(c,a.data),!0):!1},destroyed:function(){var c=findElementById(b,a.id);return c?(b.splice(b.indexOf(c),1),!0):!1},removedFrom:function(){var c=findElementById(b,a.id);if(!c)return!1;var d=findElementById(c[a.attribute],a.removedId);return d?(c[a.attribute].splice(c[a.attribute].indexOf(d),1),!0):!1},addedTo:function(){var c=findElementById(b,a.id);if(!c)return!1;var f=findElementById(c[a.attribute],a.addedId);return f?!1:(g(["",e,a.id,a.attribute,a.addedId].join("/")).then(function(b){return b&&b.length?void c[a.attribute].push(b.pop()):void d.log(["Failed to receive child entity",a.attribute,"with id",a.addedId,"from collection",e,"id",a.id].join())}),!1)}};f[a.verb]?f[a.verb]()&&c(function(){h.$apply()}):d.log("Unknown action »"+a.verb+"«")}function l(){h.$watchCollection(e+"s",function(a,c){var d,i;a=a||[],c=c||[],d=diff(a,c),i=diff(c,a),i.forEach(function(a){g("/"+m+e+"/"+a.id).then(function(c){c&&!c.error&&(b.$broadcast(e,{id:a.id,verb:"destroyed",scope:h.$id}),io.socket["delete"]("/"+m+e+"/"+a.id))})}),d.forEach(function(a){a.id||io.socket.post("/"+m+e,a,function(c){g("/"+m+e+"/"+c.id).then(function(c){angular.extend(a,c),b.$broadcast(e,{id:a.id,verb:"created",scope:h.$id,data:angular.copy(a)})})})}),f(d,h,e,m)})}var m=e.split("/");m.length>1?(e=m.splice(m.length-1,1),m=m.join("/")+"/"):m="";var n=new a.defer,o=g("/"+m+e,i);return o.then(function(a){Array.isArray(a)||(a=[a]),h[e+"s"]=a,f(a,h,e,m),"function"==typeof j&&j(),l(),n.resolve()}),io.socket.on(e,k),h.$on(e,function(a,b){h.$id!=b.scope&&k(b)}),n.promise},f=function(a,c,d,e){a.forEach(function(a){c.$watchCollection(d+"s["+c[d+"s"].indexOf(a)+"]",function(a,f){f&&a&&(angular.equals(f,a)||f.id!=a.id||f.updatedAt!==a.updatedAt||(b.$broadcast(d,{id:f.id,verb:"updated",scope:c.$id,data:angular.extend(angular.copy(a),{updatedAt:(new Date).toISOString()})}),io.socket.put("/"+e+d+"/update/"+f.id,angular.copy(a))))})})},g=function(c,d){var e=new a.defer;return d=d||{},io.socket.get(c,d,function(a){b.$apply(e.resolve(a))}),e.promise};return{bind:e}}]),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{enumerable:!1,configurable:!0,writable:!0,value:function(a){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(f in c&&(b=c[f],a.call(e,b,f,c)))return b;return void 0}});