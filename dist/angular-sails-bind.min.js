/*! angular-sails-bind - v1.0.5 - 2015-05-15
* https://github.com/diegopamio/angular-sails-bind
* Copyright (c) 2015 Diego Pamio; Licensed MIT */
try{angular.module("ngSails"),angular.module("ngSailsBind",["ngSails"])}catch(e){angular.module("ngSailsBind",[]).factory("$sails",function(){return io.socket})}angular.module("ngSailsBind").factory("$sailsBind",["$q","$rootScope","$timeout","$log","$sails",function(a,b,c,d,e){"use strict";function f(b,c,d){var f=g(b,c,d),i=new a.defer,j=p(f,null);return y(f,j,d).then(function(a){angular.isArray(a)||(a=[a]);var b=t(f.scope,f.scopeProperty);b.data=a,b.updatedData=angular.copy(a),E(f.scope,f.scopeProperty,a),w(a,f),l(f),i.resolve()}),e.on(f.model,h.bind(this,f)),f.scope.$on(f.model,function(a,b){f.scope.$id!==b.scope&&h(f,b)}),i.promise}function g(a,b,c){angular.isObject(a)?(a.hasOwnProperty("scopeProperty")||(a.scopeProperty=a.model.split("/").pop()+"s"),a.hasOwnProperty("scope")||void 0===b||(a.scope=b),a.hasOwnProperty("query")||void 0===c||(c=a.query)):(a={model:a,scopeProperty:a.split("/").pop()+"s",scope:b},void 0!==c&&(a.query=c)),a.prefix=a.model.split("/"),a.length>1?(a.model=a.prefix.splice(a.prefix.length-1,1),a.prefix=a.prefix.join("/")+"/"):a.prefix="";var d=t(a.scope,a.scopeProperty,!0);return d.options=a,a}function h(a,b){var e=[],f={created:i,updated:j,destroyed:k},g=x("autoUpdate",a);if(g)e=F(a.scope,a.scopeProperty,[]);else{var h=t(a.scope,a.scopeProperty);h&&(e=h.updatedData)}f[b.verb]?f[b.verb](a,b,e)&&c(function(){a.scope.$apply()}):d.log("Unknown action »"+b.verb+"«")}function i(a,b,c){return c.push(b.data),!0}function j(a,b,c){var d=H(c,function(a){return b.id.toString()===a.id.toString()});return d?(angular.extend(d,b.data),!0):!1}function k(a,b,c){var d=H(c,function(a){return b.id.toString()===a.id.toString()});return d?(c.splice(c.indexOf(d),1),!0):!1}function l(a){a.scope.$watchCollection(a.scopeProperty,function(b,c){m(a,b,c)})}function m(a,b,c){b=b||[],c=c||[];var d=G(b,c),e=G(c,b);angular.forEach(e,n.bind(this,a)),angular.forEach(d,o.bind(this,a)),w(d,a)}function n(a,b){var c=p(a,null,b.id),d=x("autoSave",a);d&&y(a,c).then(function(d){d&&!d.error&&(v(a,B(a,b,"destroyed")),v("change",A("destroyed",a,b)),c=p(a,"destroy",b.id),e["delete"](c,function(d,e){e.error&&(v("error",a,z(e,"delete",c,{})),v(a,B(a,b,"error")))}))})}function o(a,b){var c=x("autoSave",a);if(!b.id&&c){var d=p(a,"create");e.put(d,b,function(c,e){e.error?(v("error",a,z(e,"put",d,b)),v(a,B(a,b,"error"))):(d=p(a,null,c.id),y(a,d).then(function(c){angular.extend(b,c),v("change",A("created",a,b)),v(a,B(a,b,"created",angular.copy(b)))}))})}}function p(a,b,c){var d="/"+a.prefix+a.model;return d+=b?"/"+b+"/":"/",d+=c?"?id="+c:""}function q(){J=angular.copy(K)}function r(a){I(J,a)}function s(a,b){var c=t(a,b);if(c){var d=angular.copy(c.options);d.autoSave=!0,m(d,c.data,F(a,b))}}function t(a,b,c){if(M.hasOwnProperty(b)){if(M[b].hasOwnProperty(a.$id))return M[b][a.$id];if(c)return M[b][a.$id]={},M[b][a.$id]}else if(c)return M[b]={},M[b][a.$id]={},M[b][a.$id]}function u(a,b,c){if(!L.hasOwnProperty(a))throw new Error("Cannot register for event: "+a);L[a].push({callback:b,context:c})}function v(a,c){var d;if(angular.isString(a)){for(var e=[],f=1;f<arguments.length;f++)e.push(arguments[f]);d=x("broadcastType",c).toLowerCase(),L.hasOwnProperty(a)&&angular.forEach(L[a],function(f){f.callback.apply(f.context,e);var g=x("broadcast."+a,c);g!==!0||"simple"!==d&&"both"!==d||b.$broadcast.apply(b,["angularSailsBind."+a].concat(e))})}else if(angular.isObject(a)){var g=c;c=a,a=c.model,d=x("broadcastType",c).toLowerCase();var h=x("broadcast.models."+a,c);("model"===d||"both"===d)&&(h===!0||void 0===h)&&b.$broadcast(a,g)}}function w(a,b){function c(a){var c=F(b.scope,b.scopeProperty,[]).indexOf(a),e=b.scopeProperty+"["+c+"]";b.scope.$watchCollection(e,d)}function d(a,c){if(c&&a&&!angular.equals(c,a)&&c.id===a.id&&c.updatedAt===a.updatedAt){var d=angular.extend(angular.copy(a),{updatedAt:(new Date).toISOString()});v(b,B(b,c,"updated",d)),v("updated",A("updated",b,d));var f=x("autoSave",b);if(f){var g=p(b,"update",c.id),h=angular.copy(a);e.post(g,h,function(a,d){d.error&&(v("error",b,z(d,"post",g,h)),v(b,B(b,c,"error")))})}}}a.forEach(c)}function x(a,b){return F(b,a,F(J,a))}function y(c,d,f){var g=new a.defer;return f=f||{},e.get(d,f,function(a,e){e.error?(v("error",c,z(e,"get",d,f)),v(c,B(c,"error"))):b.$apply(g.resolve(a))}),g.promise}function z(a,b,c,d){return{target:{src:c,method:b,content:d||{}},type:a.statusCode,message:C(a.statusCode,a.body)}}function A(a,b,c){return{target:{scopeProperty:b.scopeProperty,id:c.id},type:a}}function B(a,b,c,d){var e;return angular.isString(b)?(e={verb:b,scope:a.scope.$id},d=c):e={id:b.id,verb:c,scope:a.scope.$id},void 0!==d&&(e.data=d),e}function C(a,b){return angular.isString(b)?b:N.hasOwnProperty(a)?N[a]:void 0}function D(){var a;try{a=Function("return this")()||(42,eval)("this")}catch(b){a=window}return a.hasOwnProperty("describe")&&a.hasOwnProperty("it")}function E(a,b,c){for(var d=b.split("."),e=a,f=d.pop();d.length;)e[d[0]]=a[d[0]]||{},e=a[d.shift()];e[f]=c}function F(a,b,c){for(b=angular.isArray(b)?b:b.split(".");b.length&&(a=a[b.shift()]););return void 0===a?c:a}function G(a,b){return a.filter(function(a){return b.indexOf(a)<0})}function H(a,b,c){if("function"!=typeof b)throw new TypeError("predicate must be a function");for(var d,e=Object(a),f=e.length>>>0,g=0;f>g;g++)if(d=e[g],b.call(c,d,g,e))return d;return void 0}function I(a){for(var b=1;b<arguments.length;b++)for(var c in arguments[b])if(arguments[b].hasOwnProperty(c)){if(angular.isObject(arguments[b][c])&&angular.isObject(a[c])){I(a[c],arguments[b][c]);continue}a[c]=arguments[b][c]}return a}var J={autoSave:!0,autoUpdate:!0,broadcast:{error:!1,change:!1,models:{}},broadcastType:"model"},K=angular.copy(J),L={error:[],change:[]},M={},N={400:"Malformed resource request.",401:"Not authorized to access this resource.",402:"Payment required to access this resource.",403:"Access to this resource is forbidden.",404:"Resource not found.",405:"Requests to resource using this method is not allowed.",406:"Cannot send resource in acceptable format.",407:"Proxy authentication required to access this resource.",408:"Request timeout.",409:"There is a conflict in your request, which cannot be resolved by the server.",410:"This resource is no-longer available, please update your client.",500:"Server error",501:"Requested service or feature is not implimented",502:"Could not forward the response through proxy.",503:"Server not available.",504:"Proxy timeout."},O={bind:f,on:u,save:s,config:r,"default":q};return D()&&(O.setObjectProperty=E,O.getObjectProperty=F),O}]);