/*! angular-sails-bind - v1.0.5 - 2015-05-16
* https://github.com/diegopamio/angular-sails-bind
* Copyright (c) 2015 Diego Pamio; Licensed MIT */
try{angular.module("ngSails"),angular.module("ngSailsBind",["ngSails"])}catch(e){angular.module("ngSailsBind",[]).factory("$sails",function(){return io.socket})}angular.module("ngSailsBind").factory("$sailsBindHelper",function(){"use strict";function a(a,b,c){for(var d=b.split("."),e=a,f=d.pop();d.length;)e[d[0]]=a[d[0]]||{},e=a[d.shift()];e[f]=c}function b(a,b,c){for(b=angular.isArray(b)?b:b.split(".");b.length&&(a=a[b.shift()]););return void 0===a?c:a}function c(a,b){return a.filter(function(a){return b.indexOf(a)<0})}function d(a,b,c){if("function"!=typeof b)throw new TypeError("predicate must be a function");for(var d,e=Object(a),f=e.length>>>0,g=0;f>g;g++)if(d=e[g],b.call(c,d,g,e))return d;return void 0}function e(a){for(var b=1;b<arguments.length;b++)for(var c in arguments[b])if(arguments[b].hasOwnProperty(c)){if(angular.isObject(arguments[b][c])&&angular.isObject(a[c])){e(a[c],arguments[b][c]);continue}a[c]=arguments[b][c]}return a}function f(){var a;try{a=Function("return this")()||(42,eval)("this")}catch(b){a=window}return a.hasOwnProperty("describe")&&a.hasOwnProperty("it")}var g={setObjectProperty:a,getObjectProperty:b,find:d,diff:c,merge:e};return f(),g}),angular.module("ngSailsBind").factory("$sailsBind",["$q","$rootScope","$timeout","$log","$sails","$sailsBindHelper",function(a,b,c,d,e,f){"use strict";function g(b,c,d){var g=h(b,c,d),j=new a.defer,k=q(g,null);return z(g,k,d).then(function(a){angular.isArray(a)||(a=[a]);var b=u(g.scope,g.scopeProperty);b.data=a,b.updatedData=angular.copy(a),f.setObjectProperty(g.scope,g.scopeProperty,a),x(a,g),m(g),j.resolve()}),e.on(g.model,i.bind(this,g)),g.scope.$on(g.model,function(a,b){g.scope.$id!==b.scope&&i(g,b)}),j.promise}function h(a,b,c){angular.isObject(a)?(a.hasOwnProperty("scopeProperty")||(a.scopeProperty=a.model.split("/").pop()+"s"),a.hasOwnProperty("scope")||void 0===b||(a.scope=b),a.hasOwnProperty("query")||void 0===c||(c=a.query)):(a={model:a,scopeProperty:a.split("/").pop()+"s",scope:b},void 0!==c&&(a.query=c)),a.prefix=a.model.split("/"),a.length>1?(a.model=a.prefix.splice(a.prefix.length-1,1),a.prefix=a.prefix.join("/")+"/"):a.prefix="";var d=u(a.scope,a.scopeProperty,!0);return d.options=a,a}function i(a,b){var e=[],g={created:j,updated:k,destroyed:l},h=y("autoUpdate",a);if(h)e=f.getObjectProperty(a.scope,a.scopeProperty,[]);else{var i=u(a.scope,a.scopeProperty);i&&(e=i.updatedData)}g[b.verb]?g[b.verb](a,b,e)&&c(function(){a.scope.$apply()}):d.log("Unknown action »"+b.verb+"«")}function j(a,b,c){return c.push(b.data),!0}function k(a,b,c){var d=f.find(c,function(a){return b.id.toString()===a.id.toString()});return d?(angular.extend(d,b.data),!0):!1}function l(a,b,c){var d=f.find(c,function(a){return b.id.toString()===a.id.toString()});return d?(c.splice(c.indexOf(d),1),!0):!1}function m(a){a.scope.$watchCollection(a.scopeProperty,function(b,c){n(a,b,c)})}function n(a,b,c){b=b||[],c=c||[];var d=f.diff(b,c),e=f.diff(c,b);angular.forEach(e,o.bind(this,a)),angular.forEach(d,p.bind(this,a)),x(d,a)}function o(a,b){var c=q(a,null,b.id),d=y("autoSave",a);d&&z(a,c).then(function(d){d&&!d.error&&(w(a,C(a,b,"destroyed")),w("change",B("destroyed",a,b)),c=q(a,"destroy",b.id),e["delete"](c,function(d,e){e.error&&(w("error",a,A(e,"delete",c,{})),w(a,C(a,b,"error")))}))})}function p(a,b){var c=y("autoSave",a);if(!b.id&&c){var d=q(a,"create");e.put(d,b,function(c,e){e.error?(w("error",a,A(e,"put",d,b)),w(a,C(a,b,"error"))):(d=q(a,null,c.id),z(a,d).then(function(c){angular.extend(b,c),w("change",B("created",a,b)),w(a,C(a,b,"created",angular.copy(b)))}))})}}function q(a,b,c){var d="/"+a.prefix+a.model;return d+=b?"/"+b+"/":"/",d+=c?"?id="+c:""}function r(){F=angular.copy(G)}function s(a){f.merge(F,a)}function t(a,b){var c=u(a,b);if(c){var d=angular.copy(c.options);d.autoSave=!0,n(d,c.data,f.getObjectProperty(a,b))}}function u(a,b,c){if(I.hasOwnProperty(b)){if(I[b].hasOwnProperty(a.$id))return I[b][a.$id];if(c)return I[b][a.$id]={},I[b][a.$id]}else if(c)return I[b]={},I[b][a.$id]={},I[b][a.$id]}function v(a,b,c){if(!H.hasOwnProperty(a))throw new Error("Cannot register for event: "+a);H[a].push({callback:b,context:c})}function w(a,c){var d;if(angular.isString(a)){for(var e=[],f=1;f<arguments.length;f++)e.push(arguments[f]);d=y("broadcastType",c).toLowerCase(),H.hasOwnProperty(a)&&angular.forEach(H[a],function(f){f.callback.apply(f.context,e);var g=y("broadcast."+a,c);g!==!0||"simple"!==d&&"both"!==d||b.$broadcast.apply(b,["angularSailsBind."+a].concat(e))})}else if(angular.isObject(a)){var g=c;c=a,a=c.model,d=y("broadcastType",c).toLowerCase();var h=y("broadcast.models."+a,c);("model"===d||"both"===d)&&(h===!0||void 0===h)&&b.$broadcast(a,g)}}function x(a,b){function c(a){var c=f.getObjectProperty(b.scope,b.scopeProperty,[]).indexOf(a),e=b.scopeProperty+"["+c+"]";b.scope.$watchCollection(e,d)}function d(a,c){if(c&&a&&!angular.equals(c,a)&&c.id===a.id&&c.updatedAt===a.updatedAt){var d=angular.extend(angular.copy(a),{updatedAt:(new Date).toISOString()});w(b,C(b,c,"updated",d)),w("updated",B("updated",b,d));var f=y("autoSave",b);if(f){var g=q(b,"update",c.id),h=angular.copy(a);e.post(g,h,function(a,d){d.error&&(w("error",b,A(d,"post",g,h)),w(b,C(b,c,"error")))})}}}a.forEach(c)}function y(a,b){return f.getObjectProperty(b,a,f.getObjectProperty(F,a))}function z(c,d,f){var g=new a.defer;return f=f||{},e.get(d,f,function(a,e){e.error?(w("error",c,A(e,"get",d,f)),w(c,C(c,"error"))):b.$apply(g.resolve(a))}),g.promise}function A(a,b,c,d){return{target:{src:c,method:b,content:d||{}},type:a.statusCode,message:D(a.statusCode,a.body)}}function B(a,b,c){return{target:{scopeProperty:b.scopeProperty,id:c.id},type:a}}function C(a,b,c,d){var e;return angular.isString(b)?(e={verb:b,scope:a.scope.$id},d=c):e={id:b.id,verb:c,scope:a.scope.$id},void 0!==d&&(e.data=d),e}function D(a,b){return angular.isString(b)?b:J.hasOwnProperty(a)?J[a]:void 0}function E(){var a;try{a=Function("return this")()||(42,eval)("this")}catch(b){a=window}return a.hasOwnProperty("describe")&&a.hasOwnProperty("it")}var F={autoSave:!0,autoUpdate:!0,broadcast:{error:!1,change:!1,models:{}},broadcastType:"model"},G=angular.copy(F),H={error:[],change:[]},I={},J={400:"Malformed resource request.",401:"Not authorized to access this resource.",402:"Payment required to access this resource.",403:"Access to this resource is forbidden.",404:"Resource not found.",405:"Requests to resource using this method is not allowed.",406:"Cannot send resource in acceptable format.",407:"Proxy authentication required to access this resource.",408:"Request timeout.",409:"There is a conflict in your request, which cannot be resolved by the server.",410:"This resource is no-longer available, please update your client.",500:"Server error",501:"Requested service or feature is not implimented",502:"Could not forward the response through proxy.",503:"Server not available.",504:"Proxy timeout."},K={bind:g,on:v,save:t,config:s,"default":r};return E(),K}]);