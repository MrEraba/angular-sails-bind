/*! angular-sails-bind - v1.0.5 - 2015-05-14
* https://github.com/diegopamio/angular-sails-bind
* Copyright (c) 2015 Diego Pamio; Licensed MIT */
try{angular.module("ngSails"),angular.module("ngSailsBind",["ngSails"])}catch(e){angular.module("ngSailsBind",[]).factory("$sails",function(){return io.socket})}angular.module("ngSailsBind").factory("$sailsBind",["$q","$rootScope","$timeout","$log","$sails",function(a,b,c,d,e){"use strict";function f(b,f,g){function h(a){var b=v(j.scope,j.scopeProperty,[]),e={created:function(){return v(j.scope,j.scopeProperty,[]).push(a.data),!0},updated:function(){var c=x(b,function(b){return a.id.toString()===b.id.toString()});return c?(angular.extend(c,a.data),!0):!1},destroyed:function(){var c=x(b,function(b){return a.id.toString()===b.id.toString()});return c?(b.splice(b.indexOf(c),1),!0):!1}};e[a.verb]?e[a.verb]()&&c(function(){j.scope.$apply()}):d.log("Unknown action »"+a.verb+"«")}function i(){j.scope.$watchCollection(j.scopeProperty,function(a,b){var c,d;a=a||[],b=b||[],c=w(a,b),d=w(b,a),d.forEach(function(a){o(j,"/"+j.prefix+j.model+"?id="+a.id).then(function(b){if(b&&!b.error){k(j,r(j,a,"destroyed")),k("change",q("destroyed",j,a));var c="/"+j.prefix+j.model+"/destroy/"+a.id;e["delete"](c,function(b,d){d.error&&(k("error",j,p(d,"delete",c,{})),k(j,r(j,a,"error")))})}})}),c.forEach(function(a){if(!a.id){var b="/"+j.prefix+j.model+"/create/";e.put(b,a,function(c,d){d.error?(k("error",j,p(d,"put",b,a)),k(j,r(j,a,"error"))):o(j,"/"+j.prefix+j.model+"/"+c.id).then(function(b){angular.extend(a,b),k("change",q("created",j,a)),k(j,r(j,a,"created",angular.copy(a)))})})}}),l(c,j)})}var j=m(b,f,g),n=new a.defer,s=o(j,"/"+j.prefix+j.model,g);return s.then(function(a){angular.isArray(a)||(a=[a]),u(j.scope,j.scopeProperty,a),l(a,j),i(),n.resolve()}),e.on(j.model,h),j.scope.$on(j.model,function(a,b){j.scope.$id!==b.scope&&h(b)}),n.promise}function g(){z=angular.copy(A)}function h(a){y(z,a)}function i(a){}function j(a,b,c){if(!B.hasOwnProperty(a))throw new Error("Cannot register for event: "+a);B[a].push({callback:b,context:c})}function k(a,c){var d;if(angular.isString(a)){for(var e=[],f=1;f<arguments.length;f++)e.push(arguments[f]);d=n("broadcastType",c).toLowerCase(),B.hasOwnProperty(a)&&angular.forEach(B[a],function(f){f.callback.apply(f.context,e);var g=n("broadcast."+a,c);g!==!0||"simple"!==d&&"both"!==d||b.$broadcast.apply(b,["angularSailsBind."+a].concat(e))})}else if(angular.isObject(a)){var g=c;c=a,a=c.model,d=n("broadcastType",c).toLowerCase();var h=n("broadcast.models."+a,c);("model"===d||"both"===d)&&(h===!0||void 0===h)&&b.$broadcast(a,g)}}function l(a,b){a.forEach(function(a){b.scope.$watchCollection(b.scopeProperty+"["+v(b.scope,b.scopeProperty,[]).indexOf(a)+"]",function(a,c){if(c&&a&&!angular.equals(c,a)&&c.id===a.id&&c.updatedAt===a.updatedAt){k(b,r(b,c,"updated",angular.extend(angular.copy(a),{updatedAt:(new Date).toISOString()}))),k("updated",q("destroyed",b,c));var d="/"+b.prefix+b.model+"/update/"+c.id,f=angular.copy(a);e.post(d,f,function(a,e){e.error&&(k("error",b,p(e,"post",d,f)),k(b,r(b,c,"error")))})}})})}function m(a,b,c){return angular.isObject(a)?(a.hasOwnProperty("scopeProperty")||(a.scopeProperty=a.model.split("/").pop()+"s"),a.hasOwnProperty("scope")||void 0===b||(a.scope=b),a.hasOwnProperty("query")||void 0===c||(c=a.query)):(a={model:a,scopeProperty:a.split("/").pop()+"s",scope:b},void 0!==c&&(a.query=c)),a.prefix=a.model.split("/"),a.length>1?(a.model=a.prefix.splice(a.prefix.length-1,1),a.prefix=a.prefix.join("/")+"/"):a.prefix="",a}function n(a,b){return v(b,a,v(z,a))}function o(c,d,f){var g=new a.defer;return f=f||{},e.get(d,f,function(a,e){e.error?(k("error",c,p(e,"get",d,f)),k(c,r(c,"error"))):b.$apply(g.resolve(a))}),g.promise}function p(a,b,c,d){return{target:{src:c,method:b,content:d||{}},type:a.statusCode,message:s(a.statusCode,a.body)}}function q(a,b,c){return{target:{scopeProperty:b.scopeProperty,id:c.id},type:a}}function r(a,b,c,d){var e;return angular.isString(b)?(e={verb:b,scope:a.scope.$id},d=c):e={id:b.id,verb:c,scope:a.scope.$id},void 0!==d&&(e.data=d),e}function s(a,b){return angular.isString(b)?b:C.hasOwnProperty(a)?C[a]:void 0}function t(){var a;try{a=Function("return this")()||(42,eval)("this")}catch(b){a=window}return a.hasOwnProperty("describe")&&a.hasOwnProperty("it")}function u(a,b,c){for(var d=b.split("."),e=a,f=d.pop();d.length;)e[d[0]]=a[d[0]]||{},e=a[d.shift()];e[f]=c}function v(a,b,c){for(b=angular.isArray(b)?b:b.split(".");b.length&&(a=a[b.shift()]););return void 0===a?c:a}function w(a,b){return a.filter(function(a){return b.indexOf(a)<0})}function x(a,b,c){if("function"!=typeof b)throw new TypeError("predicate must be a function");for(var d,e=Object(a),f=e.length>>>0,g=0;f>g;g++)if(d=e[g],b.call(c,d,g,e))return d;return void 0}function y(a){for(var b=1;b<arguments.length;b++)for(var c in arguments[b])if(arguments[b].hasOwnProperty(c)){if(angular.isObject(arguments[b][c])&&angular.isObject(a[c])){y(a[c],arguments[b][c]);continue}a[c]=arguments[b][c]}return a}var z={autoSave:!0,autoUpdate:!0,broadcast:{error:!1,change:!1,models:{}},broadcastType:"model"},A=angular.copy(z),B={error:[],change:[]},C={400:"Malformed resource request.",401:"Not authorized to access this resource.",402:"Payment required to access this resource.",403:"Access to this resource is forbidden.",404:"Resource not found.",405:"Requests to resource using this method is not allowed.",406:"Cannot send resource in acceptable format.",407:"Proxy authentication required to access this resource.",408:"Request timeout.",409:"There is a conflict in your request, which cannot be resolved by the server.",410:"This resource is no-longer available, please update your client.",500:"Server error",501:"Requested service or feature is not implimented",502:"Could not forward the response through proxy.",503:"Server not available.",504:"Proxy timeout."},D={bind:f,on:j,save:i,config:h,"default":g};return t()&&(D.setObjectProperty=u,D.getObjectProperty=v),D}]);