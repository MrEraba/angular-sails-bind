/*! angular-sails-bind - v1.0.5 - 2015-05-05
* https://github.com/diegopamio/angular-sails-bind
* Copyright (c) 2015 Diego Pamio; Licensed MIT */
!function(){function a(a,b){return a.filter(function(a){return b.indexOf(a)<0})}function b(a,b,c){if("function"!=typeof b)throw new TypeError("predicate must be a function");for(var d,e=Object(a),f=e.length>>>0,g=0;f>g;g++)if(d=e[g],b.call(c,d,g,e))return d;return void 0}angular.module("ngSailsBind",[]),angular.module("ngSailsBind").factory("$sailsBind",["$q","$rootScope","$timeout","$log",function(c,d,e,f){"use strict";function g(){return window.hasOwnProperty("describe")&&window.hasOwnProperty("it")}var h=function(g,h,m){function n(a){var c=l(h,p,[]),d={created:function(){return l(h,p,[]).push(a.data),!0},updated:function(){var d=b(c,function(b){return a.id==b.id});return d?(angular.extend(d,a.data),!0):!1},destroyed:function(){var d=b(c,function(b){return a.id==b.id});return d?(c.splice(c.indexOf(d),1),!0):!1}};d[a.verb]?d[a.verb]()&&e(function(){h.$apply()}):f.log("Unknown action »"+a.verb+"«")}function o(){h.$watchCollection(p,function(b,c){var e,f;b=b||[],c=c||[],e=a(b,c),f=a(c,b),f.forEach(function(a){j("/"+q+g+"?id="+a.id).then(function(b){b&&!b.error&&(d.$broadcast(g,{id:a.id,verb:"destroyed",scope:h.$id}),io.socket["delete"]("/"+q+g+"/destroy/"+a.id))})}),e.forEach(function(a){a.id||io.socket.put("/"+q+g+"/create/",a,function(b){j("/"+q+g+"/"+b.id).then(function(b){angular.extend(a,b),d.$broadcast(g,{id:a.id,verb:"created",scope:h.$id,data:angular.copy(a)})})})}),i(e,h,g,q,p)})}var p;angular.isObject(g)?(p=g.hasOwnProperty("scopeProperty")?g.scopeProperty:g.model.split("/").pop()+"s",g.hasOwnProperty("scope")&&(m=h,h=g.scope),g.hasOwnProperty("query")&&(m=g.query),g=g.model):p=g.split("/").pop()+"s";var q=g.split("/");q.length>1?(g=q.splice(q.length-1,1),q=q.join("/")+"/"):q="";var r=new c.defer,s=j("/"+q+g,m);return s.then(function(a){angular.isArray(a)||(a=[a]),k(h,p,a),i(a,h,g,q,p),o(),r.resolve()}),io.socket.on(g,n),h.$on(g,function(a,b){h.$id!=b.scope&&n(b)}),r.promise},i=function(a,b,c,e,f){a.forEach(function(a){b.$watchCollection(f+"["+l(b,f,[]).indexOf(a)+"]",function(a,f){f&&a&&(angular.equals(f,a)||f.id!=a.id||f.updatedAt!==a.updatedAt||(d.$broadcast(c,{id:f.id,verb:"updated",scope:b.$id,data:angular.extend(angular.copy(a),{updatedAt:(new Date).toISOString()})}),io.socket.post("/"+e+c+"/update/"+f.id,angular.copy(a))))})})},j=function(a,b){var e=new c.defer;return b=b||{},io.socket.get(a,b,function(a){d.$apply(e.resolve(a))}),e.promise},k=function(a,b,c){for(var d=b.split("."),e=a,f=d.pop();d.length;)a[d[0]]=angular.isObject(a[d[0]])||{},e=a[d.shift()];e[f]=c},l=function(a,b,c){for(b=angular.isArray(b)?b:b.split(".");b.length&&(a=a[b.shift()]););return void 0===a?c:a},m={bind:h};return g()&&(m.setObjectProperty=k,m.getObjectProperty=l),m}])}();