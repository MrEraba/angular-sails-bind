/*! angular-sails-bind - v1.0.5 - 2015-05-09
* https://github.com/diegopamio/angular-sails-bind
* Copyright (c) 2015 Diego Pamio; Licensed MIT */
!function(){function a(a,b){return a.filter(function(a){return b.indexOf(a)<0})}function b(a,b,c){if("function"!=typeof b)throw new TypeError("predicate must be a function");for(var d,e=Object(a),f=e.length>>>0,g=0;f>g;g++)if(d=e[g],b.call(c,d,g,e))return d;return void 0}try{angular.module("ngSails");angular.module("ngSailsBind",["ngSails"])}catch(c){angular.module("ngSailsBind",[]).factory("$sails",function(){return io.socket})}angular.module("ngSailsBind").factory("$sailsBind",["$q","$rootScope","$timeout","$log","$sails",function(c,d,e,f,g){"use strict";function h(){return window.hasOwnProperty("describe")&&window.hasOwnProperty("it")}var i=function(h,i,n){function o(a){var c=m(i,q,[]),d={created:function(){return m(i,q,[]).push(a.data),!0},updated:function(){var d=b(c,function(b){return a.id==b.id});return d?(angular.extend(d,a.data),!0):!1},destroyed:function(){var d=b(c,function(b){return a.id==b.id});return d?(c.splice(c.indexOf(d),1),!0):!1}};d[a.verb]?d[a.verb]()&&e(function(){i.$apply()}):f.log("Unknown action »"+a.verb+"«")}function p(){i.$watchCollection(q,function(b,c){var e,f;b=b||[],c=c||[],e=a(b,c),f=a(c,b),f.forEach(function(a){k("/"+r+h+"?id="+a.id).then(function(b){b&&!b.error&&(d.$broadcast(h,{id:a.id,verb:"destroyed",scope:i.$id}),g["delete"]("/"+r+h+"/destroy/"+a.id))})}),e.forEach(function(a){a.id||g.put("/"+r+h+"/create/",a,function(b){k("/"+r+h+"/"+b.id).then(function(b){angular.extend(a,b),d.$broadcast(h,{id:a.id,verb:"created",scope:i.$id,data:angular.copy(a)})})})}),j(e,i,h,r,q)})}var q;angular.isObject(h)?(q=h.hasOwnProperty("scopeProperty")?h.scopeProperty:h.model.split("/").pop()+"s",h.hasOwnProperty("scope")&&(n=i,i=h.scope),h.hasOwnProperty("query")&&(n=h.query),h=h.model):q=h.split("/").pop()+"s";var r=h.split("/");r.length>1?(h=r.splice(r.length-1,1),r=r.join("/")+"/"):r="";var s=new c.defer,t=k("/"+r+h,n);return t.then(function(a){angular.isArray(a)||(a=[a]),l(i,q,a),j(a,i,h,r,q),p(),s.resolve()}),g.on(h,o),i.$on(h,function(a,b){i.$id!=b.scope&&o(b)}),s.promise},j=function(a,b,c,e,f){a.forEach(function(a){b.$watchCollection(f+"["+m(b,f,[]).indexOf(a)+"]",function(a,f){f&&a&&(angular.equals(f,a)||f.id!=a.id||f.updatedAt!==a.updatedAt||(d.$broadcast(c,{id:f.id,verb:"updated",scope:b.$id,data:angular.extend(angular.copy(a),{updatedAt:(new Date).toISOString()})}),g.post("/"+e+c+"/update/"+f.id,angular.copy(a))))})})},k=function(a,b){var e=new c.defer;return b=b||{},g.get(a,b,function(a){d.$apply(e.resolve(a))}),e.promise},l=function(a,b,c){for(var d=b.split("."),e=a,f=d.pop();d.length;)a[d[0]]=angular.isObject(a[d[0]])||{},e=a[d.shift()];e[f]=c},m=function(a,b,c){for(b=angular.isArray(b)?b:b.split(".");b.length&&(a=a[b.shift()]););return void 0===a?c:a},n={bind:i};return h()&&(n.setObjectProperty=l,n.getObjectProperty=m),n}])}();